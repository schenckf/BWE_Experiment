---
title: "PrelimAnalysis_19SEP2017"
author: "Forest Schenck"
date: "September 19, 2017"
output: pdf_document
---

#PACKAGES
```{r}
library(dplyr)
library(sciplot)
library(car)
library(lme4)
library(ggplot2)
library(nlme)
library(multcomp)

source("http://faraway.neu.edu/data/Rprofile")

#Spatial analyses
library(mapplots)

#bootstrapping
library(boot)
```

#Importing/wrangling data
```{r}
bwe <- read.csv("bwe_data.csv") #importing from dropbox
str(bwe)

bwe$rep <- as.factor(bwe$rep)
bwe$bin <- as.factor(bwe$bin)

bwe$cells.absent <- 1-bwe$cells.present
bwe$lesion.absent <- 1-bwe$lesion

bwe.pot <- bwe %>%
  #filter(treatment == "cold" | treatment =="hot") %>% #omitting pulse treatment 
  #filter(cell.mg < 100) %>% #omitting large cell values
  filter(treatment != "pulse") %>%
  filter(bin != "1") %>%
  group_by(diversity, pot, treatment, bin, rep) %>%
  summarize(map.X = mean(map.X), map.Y = mean(map.Y), density = sum(density, na.rm = T), length.mean = mean(length.cm, na.rm = T), length.sum = sum(length.cm, na.rm = T), Lprevalence = mean(lesion, na.rm = T), Lpresent = sum(lesion, na.rm = T), Labsent = sum(lesion.absent, na.rm = T), Lseverity = mean(lc.FS, na.rm = T)/100, Cprevalence = mean(cells.present, na.rm = T), Cpresent = sum(cells.present, na.rm = T), Cabsent = sum(cells.absent, na.rm = T), Cseverity = mean(cell.mg, na.rm = T))

bwe.pot$Lpresent <- as.numeric(bwe.pot$Lpresent)
bwe.pot$Cpresent  <- as.numeric(bwe.pot$Cpresent)

bwe.pot$Cseverity.round <- ceiling(bwe.pot$Cseverity) #rounding Cseverity to nearest integer > than Cseverity value

bwe.pot$Lprevalence.arcsine <- asin(sqrt(bwe.pot$Lprevalence)) #arcsine transformation of Lprevalence data
bwe.pot$Lprevalence.logit <- log((bwe.pot$Lprevalence-0.001)/(1-(bwe.pot$Lprevalence-0.001))) #logit transformation of Lprevalence data

bwe.pot$Lseverity.arcsine <-asin(sqrt(bwe.pot$Lseverity)) #arcsine transformation of Lprevalence data
bwe.pot$Lseverity.logit <- log((bwe.pot$Lseverity)/(1-bwe.pot$Lseverity)) #logit transformation of Lseverity data

bwe.pot$Cprevalence.arcsine <- asin(sqrt(bwe.pot$Cprevalence)) #arcsine transformation of Cprevalence data
bwe.pot$Cprevalence.logit <- log((bwe.pot$Cprevalence + 0.001)/(1 - (bwe.pot$Cprevalence + 0.001))) #logit transformation of Cprevalence data
#bwe.pot$Cprevalence.logit[7] <- log((bwe.pot$Cprevalence [7] - 0.001)/(1 - (bwe.pot$Cprevalence[7] - 0.001))) #logit transformation of Cprevalence data continued

bwe.pot$Cseverity.sqrt <- sqrt(bwe.pot$Cseverity) #sqrt transformation of Cseverity data
bwe.pot$Cseverity.inv <- 1/(bwe.pot$Cseverity+1)
bwe.pot$Cseverity.log <- log(bwe.pot$Cseverity+1)

str(bwe.pot)
head(bwe.pot)

bwe.pot.Lintensity <- bwe %>%
  filter(lesion > 0) %>%
  filter(treatment != "pulse") %>%
  filter(bin != "1") %>%
  group_by(diversity, pot, treatment, bin, rep) %>%
  summarize(Lintensity= mean(lc.FS, na.rm = T)/100, length.mean = mean(length.cm, na.rm = T), length.sum = sum(length.cm, na.rm = T)) #subsetting data by lesion prevalence > 0 to measure lesion intensity

bwe.pot.Lintensity$Lintensity.arcsine <- asin(sqrt(bwe.pot.Lintensity$Lintensity)) #arcsine transformation of Lintensity
bwe.pot.Lintensity$Lintensity.logit <- log(bwe.pot.Lintensity$Lintensity/(1-bwe.pot.Lintensity$Lintensity))
str(bwe.pot.Lintensity)

bwe.pot.subset <- data.frame(bwe.pot$diversity, bwe.pot$pot, bwe.pot$bin, bwe.pot$treatment, bwe.pot$rep, bwe.pot$density)
str(bwe.pot.subset)
colnames(bwe.pot.subset) <- c("diversity", "pot", "bin", "treatment", "rep", "density") #making a factor that includes density in entire pot, not just infected individuals

bwe.pot.Lintensity <- merge(bwe.pot.Lintensity, bwe.pot.subset, by = c("diversity", "pot", "bin" , "treatment", "rep"), all = T)


bwe$lc.cell<- ifelse(bwe$cells.present == 0, 0, bwe$lc.FS)
bwe.pot.Lcell <- bwe %>%
  group_by(diversity, pot, treatment, bin, rep) %>%
  summarize(Lintensity= mean(lc.cell, na.rm = T)/100) #considering only lesions from disease confirmed by qPCR analyses otherwise lesion pc = 0
bwe.pot.Lcell$Lintensity.arcsine <- asin(sqrt(bwe.pot.Lcell$Lintensity)) #arcsine transformation of Lintensity qPCR
#bwe.pot.Lcell$Lintensity.logit <- log(bwe.pot.Lcell$Lintensity/(1-bwe.pot.Lcell$Lintensity)) #issues with 0's

bwe.pot.Cseverity <- bwe %>%
  filter(cell.mg < 10000) %>% #omitting large cell values
  group_by(diversity, pot, treatment, bin, rep) %>%
  summarize(Cseverity = mean(cell.mg, na.rm = T))

bwe.pot.Cintensity <- bwe %>%
  filter(cells.present > 0) %>% #only selectiong shoots with cells present
  #filter(Cq.Std.Dev < 0.5) %>% #only selecting intensities measured with Cq < 0.5
  #filter(Cq.Mean < 35) %>% #only selecting wells that flouresced earleir than Cq 35
  #filter(cell.mg < 100) %>% #omitting large cell values
  group_by(diversity, pot, treatment, bin, rep) %>%
  summarize(Cintensity = mean(cell.mg, na.rm = T), length.mean = mean(length.cm), shoots = sum(density)) #subsetting data by cell presence > 0 to measure cell intensity

bwe.pot.Cintensity$Cintensity.sqrt <- sqrt(bwe.pot.Cintensity$Cintensity) #sqrt transformed C intensity
bwe.pot.Cintensity$Cintensity.log <- log(bwe.pot.Cintensity$Cintensity)
bwe.pot.Cintensity$Cintensity.inv <- 1/bwe.pot.Cintensity$Cintensity

bwe.pot.Cintensity <- merge(bwe.pot.Cintensity, bwe.pot.subset, by = c("diversity", "pot", "bin" , "treatment", "rep"), all.x = T)

bwe.bin.Cintensity <- bwe %>% #filter out bin with only monocultures
  filter(cells.present > 0) %>%
  filter(bin != '14') %>%
  group_by(diversity, treatment, bin) %>%
  summarize (Cintensity = mean(cell.mg, na.rm = T)) #subsetting data by cell presence >0 at bin level

bwe.bin.Cintensity$Cintensity.sqrt <- sqrt(bwe.bin.Cintensity$Cintensity)

#For non-parametric test, mono's have so many more low samples which is dragging down their count compared to poly's. In order to achieve equal sample size among treatments I think I should randomly sub-sample the mono data from each temp repeatedly

bwe.pot.poly <- bwe.pot %>%
  filter(treatment != "pulse") %>%
  filter(diversity == "poly")
#10 poly hot and 10 poly cold


```

#ANALYSES
##Lesion Prevalence
```{r}
#Analyses
#Lprev.model <-  glm(cbind(Lpresent, Labsent) ~ treatment*diversity, family = binomial, data = bwe.pot)

#Lprev.model <- glm(cbind(Lpresent, Labsent) ~ treatment/diversity + density + length.mean, family = binomial, data = bwe.pot)
#Anova(Lprev.model) ##use this for P values (package = car)

#bwe.pot.xbin1 <- filter(bwe.pot, bin != "1")

Lprev.model <- lme(Lprevalence ~ treatment * diversity + density + length.mean, random = ~1 | bin, data = bwe.pot) #random effects model --> doesn't work :( #cbind(Lpresent, Labsent) #, family = binomial
anova(Lprev.model)#, test = "LR")

hist(bwe.pot$Lprevalence.arcsine)

Lprev.model <- aov(Lprevalence.arcsine ~ diversity * treatment + Error(bin), data = filter(bwe.pot.xbin1, treatment != "pulse"))
summary(Lprev.model)

Lprev.model2 <- aov(Lprevalence.arcsine ~ diversity * treatment, data = bwe.pot)
summary(Lprev.model2)
plot(Lprev.model2)
hist(residuals(Lprev.model2), main = "Arcsine Transformation")
shapiro.test(residuals(Lprev.model2))
leveneTest(Lprev.model2)

#Figure
p <- ggplot(bwe.pot.xbin1, aes(x = treatment, y = Lprevalence, fill = diversity)) + 
  scale_fill_manual(values = c("white", "grey", "")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Temperature Treatment", y = "Proportion of shoots with lesions") +
  theme_classic()
p

p <- ggplot(bwe.pot, aes(x = bin, y = Lprevalence, fill = treatment)) + 
  scale_fill_manual(values = c("white", "black", "grey")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Bin", y = "Proportion of shoots with lesions") +
  theme_classic()
p

plot(Lprevalence ~ jitter(density, 0.5), bwe.pot)
```

##Lesion severity
```{r}
#Analyses
#nlme from Tarik
Lsev.model <- lme(Lseverity ~ diversity * treatment, random = ~1 | bin / diversity, data = bwe.pot, method = "REML")
anova(Lsev.model)

#ANOVA with transformations
hist(bwe.pot$Lseverity.arcsine)

Lsev.model <- aov(Lseverity.arcsine ~ diversity * treatment + Error(bin), data = bwe.pot)
summary(Lsev.model)

#Lsev.model <- glmer(Lseverity ~ diversity * treatment + (1|bin), family = gaussian, data = bwe.pot) #checking to see if glmer formula structure correct
#anova(Lsev.model)

Lsev.model2 <- aov(Lseverity.arcsine ~ diversity * treatment, data = bwe.pot)
plot(Lsev.model2) #distribution looks ok
hist(residuals(Lsev.model2), main = 'arcsine transformation')
shapiro.test(residuals(Lsev.model2))
leveneTest(Lsev.model2)

#Figures
p <- ggplot(bwe.pot, aes(x = treatment, y = Lseverity)) + 
  #scale_fill_manual(values = c("white", "grey")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Temperature Treatment", y = "Proportion of leaf cover by lesions") +
  theme_classic()
p

p <- ggplot(bwe.pot, aes(x = bin, y = Lseverity, fill = treatment)) + 
  scale_fill_manual(values = c("white", "black", "grey")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Bin", y = "Proportion of leaf cover by lesions") +
  theme_classic()
p
#################
###################
##Lesion INTENSITY only for pots with disease
Lintensity.model <- lme(Lintensity ~ diversity * treatment + length.mean  + density, random = ~1 | bin/diversity, data = bwe.pot.Lintensity, method = "REML") #TARIK CODE using nlme package  do i need this term in model under random?(/ diversity))
anova(Lintensity.model)

#summary(glht(Lintensity.model, linfct = mcp(treatment="Tukey")))

Lintensity.model <- aov(Lintensity.arcsine ~ treatment * diversity + Error(bin), data = filter(bwe.pot.Lintensity, treatment != "pulse"))#removing bin #1 filter(bwe.pot.Lintensity, bin != "1"))
summary(Lintensity.model)

Lintensity.model2 <- aov(Lintensity.arcsine ~ treatment * diversity, data = bwe.pot.Lintensity)
summary(Lintensity.model2)
plot(Lintensity.model2)
hist(residuals(Lintensity.model2))
shapiro.test(residuals(Lintensity.model2))
leveneTest(Lintensity.model2)

#Figures
p <- ggplot(bwe.pot.Lintensity, aes(x = treatment, y = Lintensity)) + 
  #scale_fill_manual(values = c("white", "grey")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Temperature Treatment", y = "Proportion of diseased leaf cover by lesions") +
  theme_classic()
p

p <- ggplot(bwe.pot.Lintensity, aes(x = bin, y = Lintensity, fill = treatment)) + 
  scale_fill_manual(values = c("white", "black", "grey")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Bin", y = "Proportion of diseased leaf cover by lesions") +
  theme_classic()
p

plot(Lintensity ~ density, bwe.pot.Lintensity)
plot((Lintensity*100) ~ length.mean, bwe.pot.Lintensity)
abline(lm(Lintensity*100 ~ length.mean, bwe.pot.Lintensity))

#Lesion analyses only for pots with positive cell readings from qPCR
p <- ggplot(bwe.pot.Lcell, aes(x = treatment, y = Lintensity, fill = diversity)) + 
  #scale_fill_manual(values = c("white", "grey")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Temperature Treatment", y = "Proportion of diseased leaf cover by lesions") +
  theme_classic()
p

#Lesion analyses only for pots with positive cell readings from qPCR and excluding 0's
p <- ggplot(filter(bwe.pot.Lcell, Lintensity > 0), aes(x = treatment, y = Lintensity, fill = diversity)) + 
  #scale_fill_manual(values = c("white", "grey")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Temperature Treatment", y = "Proportion of diseased leaf cover by lesions") +
  theme_classic()
p

##Lesion INTENSITY only for plants with qPCR confirmed disease
Lintensity.model <- lme(Lintensity ~ diversity * treatment, random = ~1 | bin / diversity , data = filter( bwe.pot.Lcell, treatment != "pulse"), method = "REML") #TARIK CODE using nlme package !not working!
anova(Lintensity.model)

Lintensity.model <- aov(Lintensity.arcsine ~ treatment * diversity + Error(bin), data = filter(bwe.pot.Lcell, treatment != "pulse"))
summary(Lintensity.model)

Lintensity.model2 <- aov(Lintensity.arcsine ~ treatment * diversity, data = bwe.pot.Lintensity)
summary(Lintensity.model2)
plot(Lintensity.model2)
hist(residuals(Lintensity.model2))
shapiro.test(residuals(Lintensity.model2))
leveneTest(Lintensity.model2)

##Lesion INTENSITY only for plants with qPCR confirmed disease
Lintensity.model <- aov(Lintensity.arcsine ~ treatment * diversity + Error(bin), data = filter(bwe.pot.Lcell, Lintensity > 0))
summary(Lintensity.model)

Lintensity.model2 <- aov(Lintensity.arcsine ~ treatment * diversity, data = filter(bwe.pot.Lcell, Lintensity > 0))
summary(Lintensity.model2)
plot(Lintensity.model2)
hist(residuals(Lintensity.model2))
shapiro.test(residuals(Lintensity.model2))
leveneTest(Lintensity.model2)
```

##Cell Prevalence
```{r}
#Analyses
#Cprev.model <-  glm(cbind(Cpresent, Cabsent) ~ treatment + treatment:diversity, family = binomial, data = bwe.pot)
#Cprev.model <- glm(cbind(Cpresent, Cabsent) ~ treatment/diversity, family = binomial, data = bwe.pot)
#Cprev.model <- glmer(cbind(Cpresent, Cabsent) ~ treatment * diversity + (1|bin/diversity), family = binomial, data = bwe.pot)
#Cprev.model <- glmer(Cprevalence ~ treatment * diversity + (1|bin), family = poisson, data = bwe.pot)
anova(Cprev.model, test = "LR")
Anova(Cprev.model)

Cprev.model <- lme(Cprevalence ~ treatment * diversity + length.mean + density, random = ~1 | bin / diversity, data = bwe.pot) #random effects model --> doesn't work :( #cbind(Lpresent, Labsent) #, family = binomial
anova(Cprev.model)#, test = "LR")

hist(bwe.pot$Cprevalence.arcsine)

Cprev.model <- aov(Cprevalence.arcsine ~ diversity * treatment + Error(bin), data = filter(bwe.pot.xbin1, treatment != "pulse")) #excluding bin 1 because no disease detected
summary(Cprev.model)

Cprev.model2 <- aov(Cprevalence.arcsine ~ treatment * diversity, data = bwe.pot)
summary(Cprev.model2)
plot(Cprev.model2)
hist(residuals(Cprev.model2))
shapiro.test(residuals(Cprev.model2))
leveneTest(Cprev.model2)

#Figures
p <- ggplot(bwe.pot.xbin1, aes(x = treatment, y = Cprevalence, fill = diversity)) + 
  scale_fill_manual(values = c("white", "grey", "")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Temperature Treatment", y = "Proportion of shoots with Laby cells detected") +
  theme_classic()
p

p <- ggplot(bwe.pot, aes(x = bin, y = Cprevalence, fill = treatment)) + 
  scale_fill_manual(values = c("white", "grey")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Bin", y = "Proportion of shoots with Laby cells detected") +
  theme_classic()
p

plot(Cprevalence ~ length.mean, bwe.pot)
```

##Cell severity
```{r}
#Analyses ##DATA IS NOT NORMALLY DISTRIBUTED?

#Csev.model <- glm(Cseverity ~ treatment/diversity, family = poisson, data = bwe.pot)
#Anova(Csev.model)
#anova(Csev.model, test = "LR")

#standard poisson glm with rounded cell/mg values
#Anova(Csev.model <- glm(Cseverity.round ~ treatment/diversity, family = poisson, data = bwe.pot))

hist(bwe.pot$Cseverity)
hist(bwe.pot$Cseverity.sqrt)
hist(log(bwe.pot$Cseverity+1))

#Csev.model <- aov(Cseverity.sqrt ~ diversity * treatment + Error(bin), data = filter(bwe.pot, Cseverity<100))
summary(Csev.model)

Csev.model2 <- aov(Cseverity.sqrt ~ diversity, data = filter(bwe.pot, treatment == "hot" & Cseverity<100))
summary(Csev.model2)

plot(Csev.model2)
hist(residuals(Csev.model2))
shapiro.test(residuals(Csev.model2))
leveneTest(Csev.model2)

#exploratory figures
p <- ggplot(filter(bwe.pot, Cseverity <100), aes(x  = treatment, y = Cseverity.log, fill = diversity)) +
  scale_fill_manual(values = c("white", "grey")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Temperature Treatment", y = "Log Laby cells / mg") +
  #ylim(0, 1) +
  theme_classic()
p

p <- ggplot(bwe.pot, aes(x = bin, y = log(Cseverity+1), fill = treatment)) + 
  scale_fill_manual(values = c("white", "grey")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Bin", y = "Log Laby cells / mg") +
  theme_classic()
p

p <- ggplot(bwe.pot, aes(x = pot, y = Cseverity, fill = treatment)) + 
  scale_fill_manual(values = c("white", "grey")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Bin", y = "Laby cells / mg") +
  theme_classic()
p

bargraph.CI(x.factor = treatment,
            group = diversity,
            response = Cseverity.round,
            data = bwe.pot,
            ylim = c(0,500), ylab = "disease cells/mg",
            xlab = "Temperature Treatment", legend = T)
bargraph.CI(x.factor = diversity,
            response = Cseverity.round,
            data = bwe.pot,
            ylim = c(0,500), ylab = "disease cells/mg",
            xlab = "Diversity", legend = T)

#Non-parametric Kruskal-Wallace Test
bwe.pot$temp.div <- paste(bwe.pot$treatment, bwe.pot$diversity, sep = ".")
bwe.pot$temp.div <- as.factor(bwe.pot$temp.div)
bwe$temp.div <- paste(bwe$treatment, bwe$diversity, sep = ".")
bwe$temp.div <- as.factor(bwe$temp.div)
  ##treatment pot level
kruskal.test(Cseverity ~ treatment, data = filter(bwe.pot, treatment != "pulse")) #significant!
  ##Diversity pot level
kruskal.test(Cseverity ~ diversity, data = filter(bwe.pot, treatment != "pulse")) #not significant
  ##Treatment*Diversity pot level
kruskal.test(Cseverity ~ temp.div, data = filter(bwe.pot, treatment != "pulse")) #not significant :(

  ##Diversity within cold temp, pot level
kruskal.test(Cseverity ~ diversity, data = filter(bwe.pot, treatment == "cold")) #not significant
mono.wilcox <- as.matrix(subset(filter(bwe.pot, treatment == "cold"), diversity == "mono", select = "Cseverity"))
poly.wilcox <- as.matrix(subset(filter(bwe.pot, treatment == "cold"), diversity == "poly", select = "Cseverity"))
wilcox.test(mono.wilcox, poly.wilcox) #not significant
  ##Diversity within hot temp, pot level
kruskal.test(Cseverity ~ diversity, data = filter(bwe.pot, treatment == "hot")) #not significant
mono.wilcox <- as.matrix(subset(filter(bwe.pot, treatment == "hot"), diversity == "mono", select = "Cseverity"))
poly.wilcox <- as.matrix(subset(filter(bwe.pot, treatment == "hot"), diversity == "poly", select = "Cseverity"))
wilcox.test(mono.wilcox, poly.wilcox) #not signficant

  ##treatment shoot level
kruskal.test(cell.mg ~ treatment, data = bwe) #significant
  ##diversity shoot level
kruskal.test(cell.mg ~ diversity, data = bwe) #no signficant
  ##Treatment*Diversity shoot level
kruskal.test(cell.mg ~ temp.div, data = bwe) ##so freaking close!

  ##Diversity within cold temp, shoot level
kruskal.test(cell.mg ~ diversity, data = filter(bwe, treatment == "cold")) #not significant
  ##Diversity within hot temp, shoot level
kruskal.test(cell.mg ~ diversity, data = filter(bwe, treatment == "hot")) #not significant

  ###Sampling pots with replacement to help detect diversity effect (bootstrapping)
cool.mono <- as.data.frame(subset(filter(bwe.pot, treatment == "cold"), diversity == "mono", select = "Cseverity"))
cool.poly <- as.data.frame(subset(filter(bwe.pot, treatment == "cold"), diversity == "poly", select = "Cseverity"))
warm.mono <- as.data.frame(subset(filter(bwe.pot, treatment == "hot" & bin != "1"), diversity == "mono", select = "Cseverity"))
warm.poly <- as.data.frame(subset(filter(bwe.pot, treatment == "hot" & bin != "1"), diversity == "poly", select = "Cseverity"))

str(cool.poly)

    #bootstrapping by hand 1000 replicates at the pot level
      #cool mono
cool.mono.means <- replicate(1000, mean(sample(cool.mono$Cseverity, replace = T)))
quantile(cool.mono.means, probs = c(0.025, 0.975))
      #cool poly
cool.poly.means <- replicate(1000, mean(sample(cool.poly$Cseverity, replace = T)))
plot(cool.poly.means)
quantile(cool.poly.means, probs = c(0.025, 0.975))
      #warm mono
warm.mono.means <- replicate(1000, mean(sample(warm.mono$Cseverity, replace = T)))
plot(warm.mono.means)
quantile(warm.mono.means, probs = c(0.025, 0.975))
      #warm poly
warm.poly.means <- replicate(1000, mean(sample(warm.poly$Cseverity, replace = T)))
plot(warm.poly.means)
quantile(warm.poly.means, probs = c(0.025, 0.975))

  ###Sampling SHOOTS with replacement to help detect diversity effect (bootstrapping)
cool.mono.shoot <- as.data.frame(subset(filter(bwe, treatment == "cold" & cell.mg != "NA"), diversity == "mono", select = "cell.mg"))
cool.poly.shoot <- as.data.frame(subset(filter(bwe, treatment == "cold" & cell.mg != "NA"), diversity == "poly", select = "cell.mg"))
warm.mono.shoot <- as.data.frame(subset(filter(bwe, treatment == "hot" & bin != "1"& cell.mg != "NA"), diversity == "mono", select = "cell.mg"))
warm.poly.shoot <- as.data.frame(subset(filter(bwe, treatment == "hot" & bin != "1" & cell.mg != "NA"), diversity == "poly", select = "cell.mg"))
  #bootstrapping by hand 1000 replicates at the shoot level
          #cool mono
cool.mono.means <- replicate(1000, mean(sample(cool.mono.shoot$cell.mg, replace = T)))
quantile(cool.mono.means, probs = c(0.025, 0.975))
          #cool poly
cool.poly.means <- replicate(1000, mean(sample(cool.poly.shoot$cell.mg, replace = T)))
plot(cool.poly.means)
quantile(cool.poly.means, probs = c(0.025, 0.975))
         #warm mono
warm.mono.means <- replicate(1000, mean(sample(warm.mono.shoot$cell.mg, replace = T)))
plot(warm.mono.means)
quantile(warm.mono.means, probs = c(0.025, 0.975))
        #warm poly
warm.poly.means <- replicate(1000, mean(sample(warm.poly.shoot$cell.mg, replace = T)))
plot(warm.poly.means)
quantile(warm.poly.means, probs = c(0.025, 0.975))
```

##Cell INTENSITY (only plants with disease)
```{r}
############################
##Cell INTENSITY only plants with disease
#Cintensity.model <- glm(Cseverity.round ~ treatment/diversity, family = poisson, data = filter(bwe.pot, Cprevalence > 0))
#Anova(Cintensity.model)
Cintensity.model <- lme(Cintensity.log ~ diversity*treatment + shoots + length.mean, random = ~1 | bin/diversity, data = filter(bwe.pot.Cintensity, Cintensity < 100), method = "REML") #TARIK CODE using nlme package  do i need this term in model under random?(/ diversity))
anova(Cintensity.model)


hist(bwe.pot.Cintensity$Cintensity.sqrt)
hist(bwe.pot.Cintensity$Cintensity.log)

#Cintensity.model <- aov(Cintensity.sqrt ~ diversity * treatment + Error(bin), data = filter(bwe.pot.Cintensity, Cintensity < 100))
#summary(Cintensity.model)

#Cintensity.model <- aov(Cintensity.sqrt ~ diversity * treatment + Error(bin), data = bwe.bin.Cintensity)
#summary(Cintensity.model)

Cintensity.model2 <- aov(Cintensity.log ~ diversity*treatment + density, data = bwe.pot.Cintensity)
anova(Cintensity.model2)

plot(Cintensity.model2)
hist(residuals(Cintensity.model2))
shapiro.test(residuals(Cintensity.model2))
leveneTest(Cintensity.model2)

#Figure
p <- ggplot(filter(bwe.pot.Cintensity, Cintensity < 100), aes(x = treatment, y = Cintensity.log, fill = diversity)) + 
  scale_fill_manual(values = c("white", "grey")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Temperature Treatment", y = "Log of Laby cells / mg in diseased tissue") +
  #ylim(0, 1) +
  theme_classic()
p

p <- ggplot(bwe.pot.Cintensity, aes(x = bin, y = Cintensity, fill = treatment)) +
  scale_fill_manual(values = c("white", "grey")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Bin", y = "Laby cells / mg in diseased tissue") +
  theme_classic()
p

bargraph.CI(x.factor = treatment,
            group = diversity,
            response = Cintensity,
            data = bwe.bin.Cintensity,
            ylim = c(0,1500), ylab = "cells/mg",
            xlab = "Temperature Treatment", legend = T)

bargraph.CI(x.factor = treatment,
            group = diversity,
            response = Cintensity,
            data = bwe.pot.Cintensity,
            ylim = c(0,2000), ylab = "cells/mg",
            xlab = "Temperature Treatment", legend = T)

plot(Cintensity.log ~ shoots, filter(bwe.pot.Cintensity, Cintensity < 100))
abline(lm(Cintensity.log ~ shoots, filter(bwe.pot.Cintensity, Cintensity < 100)))
summary(lm(Cintensity.log ~ density, bwe.pot.Cintensity))

#Non-parametric Kruskal-Wallace Test
bwe.pot.Cintensity$temp.div <- paste(bwe.pot.Cintensity$treatment, bwe.pot.Cintensity$diversity, sep = ".")
bwe.pot.Cintensity$temp.div <- as.factor(bwe.pot.Cintensity$temp.div)
  ##treatment
kruskal.test(Cintensity ~ treatment, data = bwe.pot.Cintensity) #not significant
  ##Diversity
kruskal.test(Cintensity ~ diversity, data = bwe.pot.Cintensity) #not significant
  ##Treatment*Diversity
kruskal.test(Cintensity ~ temp.div, data = bwe.pot.Cintensity) #not significant

bwe.intensity <- filter(bwe, cell.mg > 0)
  ##treatment shoot level
kruskal.test(cell.mg ~ treatment, data = bwe.intensity) #not significant
  ##diversity shoot level
kruskal.test(cell.mg ~ diversity, data = bwe.intensity) #not signficant
  ##Treatment*Diversity shoot level
kruskal.test(cell.mg ~ temp.div, data = bwe.intensity) ##not signficant

#Catagorical cell data at pot level
#bwe.pot.Cintensity$Cintensity.cat <- NA
#for (n in 1:40) {
 # if (bwe.pot.Cintensity$Cintensity[n] < 10)
  #{bwe.pot.Cintensity$Cintensity.cat[n] = "low"
  #} else if (bwe.pot.Cintensity$Cintensity[n] > 10 & bwe.pot.Cintensity$Cintensity[n] < 100) {
    #bwe.pot.Cintensity$Cintensity.cat[n] = "mid"
  #} else {bwe.pot.Cintensity$Cintensity.cat[n] = "high"
   # }
#}

#Catagorical cell data at shoot level
bwe.intensity$cell.mg.cat <- NA
for (n in 1:63) {
  if (bwe.intensity$cell.mg[n] < 1)
  {bwe.intensity$cell.mg.cat[n] = "trace"
  } else if (bwe.intensity$cell.mg[n] > 1 & bwe.intensity$cell.mg[n] < 10) {
    bwe.intensity$cell.mg.cat[n] = "low"
  } else if (bwe.intensity$cell.mg[n] > 10 & bwe.intensity$cell.mg[n] < 100) {
    bwe.intensity$cell.mg.cat[n] = "mid"
  } else {bwe.intensity$cell.mg.cat[n] = "high"
    }
}

###Sampling SHOOTS with replacement to help detect diversity effect (bootstrapping)
cool.mono.shoot <- as.data.frame(subset(filter(bwe.intensity, treatment == "cold"), diversity == "mono", select = "cell.mg"))
cool.poly.shoot <- as.data.frame(subset(filter(bwe.intensity, treatment == "cold"), diversity == "poly", select = "cell.mg"))
warm.mono.shoot <- as.data.frame(subset(filter(bwe.intensity, treatment == "hot"), diversity == "mono", select = "cell.mg"))
warm.poly.shoot <- as.data.frame(subset(filter(bwe.intensity, treatment == "hot"), diversity == "poly", select = "cell.mg"))

#quantiles of normal data
quantile(cool.mono.shoot$cell.mg, probs = c(0, 0.5, 0.95, 1))
quantile(cool.poly.shoot$cell.mg, probs = c(0, 0.5, 0.95, 1))
quantile(warm.mono.shoot$cell.mg, probs = c(0, 0.5, 0.95, 1))
quantile(warm.poly.shoot$cell.mg, probs = c(0, 0.5, 0.95, 1))

cool.shoot <- as.data.frame(subset(bwe.intensity,treatment == "cold", select = "cell.mg"))
warm.shoot <- as.data.frame(subset(bwe.intensity, treatment == "hot", select = "cell.mg"))
  #bootstrapping by hand 1000 replicates at the shoot level
          #cool mono
cool.mono.means <- replicate(1000, mean(sample(cool.mono.shoot$cell.mg, replace = T)))
plot(cool.mono.means)
quantile(cool.mono.means, probs = c(0, 0.5, 1)) #0.025, 0.975
          #cool poly
cool.poly.means <- replicate(1000, mean(sample(cool.poly.shoot$cell.mg, replace = T)))
plot(cool.poly.means)
quantile(cool.poly.means, probs = c(0, 0.5, 1))
         #warm mono
warm.mono.means <- replicate(1000, mean(sample(warm.mono.shoot$cell.mg, replace = T)))
plot(warm.mono.means)
quantile(warm.mono.means, probs = c(0, 0.5, 1))
        #warm poly
warm.poly.means <- replicate(1000, mean(sample(warm.poly.shoot$cell.mg, replace = T)))
plot(warm.poly.means)
quantile(warm.poly.means, probs = c(0, 0.5, 1))
        #cool
cool.means <- replicate(1000, mean(sample(cool.shoot$cell.mg, replace = T)))
plot(cool.means)
quantile(cool.means, probs = c(0.025, 0.975))
        #warm
warm.means <- replicate(1000, mean(sample(warm.shoot$cell.mg, replace = T)))
plot(cool.means)
quantile(warm.means, probs = c(0.025, 0.975))

 ###Sampling pots with replacement to help detect diversity effect (bootstrapping)
cool.mono <- as.data.frame(subset(filter(bwe.pot.Cintensity, treatment == "cold"), diversity == "mono", select = "Cintensity"))
cool.poly <- as.data.frame(subset(filter(bwe.pot.Cintensity, treatment == "cold"), diversity == "poly", select = "Cintensity"))
warm.mono <- as.data.frame(subset(filter(bwe.pot.Cintensity, treatment == "hot"), diversity == "mono", select = "Cintensity"))
warm.poly <- as.data.frame(subset(filter(bwe.pot.Cintensity, treatment == "hot"), diversity == "poly", select = "Cintensity"))

str(cool.poly)

    #bootstrapping by hand 1000 replicates at the pot level
      #cool mono
cool.mono.means <- replicate(1000, mean(sample(cool.mono$Cintensity, replace = T)))
quantile(cool.mono.means, probs = c(0, 0.25, 0.5, 0.75, 1))
      #cool poly
cool.poly.means <- replicate(1000, mean(sample(cool.poly$Cintensity, replace = T)))
#plot(cool.poly.means)
quantile(cool.poly.means, probs = c(0.0, 0.25, 0.5, 0.75, 1))
      #warm mono
warm.mono.means <- replicate(1000, mean(sample(warm.mono$Cintensity, replace = T)))
#plot(warm.mono.means)
quantile(warm.mono.means, probs = c(0.0, 0.25, 0.5, 0.75, 1))
      #warm poly
warm.poly.means <- replicate(1000, mean(sample(warm.poly$Cintensity, replace = T)))
#plot(warm.poly.means)
quantile(warm.poly.means, probs = c(0.0, 0.25, 0.5, 0.75, 1))

    #building bootstrap dataframe
warm.poly.means <- as.data.frame(warm.poly.means)
warm.poly.means$treatment <- rep("warm", 1000)
warm.poly.means$diversity <- rep("poly", 1000)
colnames(warm.poly.means) <- c("Cintensity", "treatment", "diversity")
warm.mono.means <- as.data.frame(warm.mono.means)
warm.mono.means$treatment <- rep("warm", 1000)
warm.mono.means$diversity <- rep("mono", 1000)
colnames(warm.mono.means) <- c("Cintensity", "treatment", "diversity")
cool.poly.means <- as.data.frame(cool.poly.means)
cool.poly.means$treatment <- rep("cool", 1000)
cool.poly.means$diversity <- rep("poly", 1000)
colnames(cool.poly.means) <- c("Cintensity", "treatment", "diversity")
cool.mono.means <- as.data.frame(cool.mono.means)
cool.mono.means$treatment <- rep("cool", 1000)
cool.mono.means$diversity <- rep("mono", 1000)
colnames(cool.mono.means) <- c("Cintensity", "treatment", "diversity")

#logtrasnformations
cool.mono.means$Cintensity.log <- log(cool.mono.means$Cintensity)
cool.poly.means$Cintensity.log <- log(cool.poly.means$Cintensity)
warm.mono.means$Cintensity.log <- log(warm.mono.means$Cintensity)
warm.poly.means$Cintensity.log <- log(warm.poly.means$Cintensity)


    #ploting data
hist(cool.mono.means$Cintensity)
hist(cool.poly.means$Cintensity)
hist(warm.mono.means$Cintensity)
hist(warm.poly.means$Cintensity)

bootstrap.cellint <- rbind(warm.poly.means, warm.mono.means, cool.poly.means, cool.mono.means)
bootstrap.cellint$treatment <- as.factor(bootstrap.cellint$treatment)
bootstrap.cellint$diversity <- as.factor(bootstrap.cellint$diversity)
bootstrap.cellint$Cintensity.inv <- 1/bootstrap.cellint$Cintensity
str(bootstrap.cellint)

p <- ggplot(bootstrap.cellint, aes(x = treatment, y = Cintensity, fill = diversity)) + 
  scale_fill_manual(values = c("white", "grey")) +
  geom_violin(position = position_dodge(1)) +
  #geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(x = "Temperature Treatment", y = "Bootstrap Cell intensity") +
  #ylim(0, 1) +
  theme_classic()
p

bargraph.CI(x.factor = treatment,
            group = diversity,
            response = Cintensity.inv,
            data = bootstrap.cellint,
            ylim = c(0,3), ylab = "1/disease cells/mg",
            xlab = "Temperature Treatment", legend = T)

#Models
#bootstrap.Cint.model <- lme(Cintenstiy ~ diversity * treatment, random = ~1 | bin/diversity, data = bootstrap.cellint, method = "REML") #TARIK CODE using nlme package  I need to figure out a way to get bin ... may not bake sense?
#anova(bootstrap.Cint.model)

#summary(glht(Lintensity.model, linfct = mcp(treatment="Tukey")))

bootstrap.Cint.model <- aov(Cintensity.log ~ treatment * diversity, data = bootstrap.cellint)
anova(bootstrap.Cint.model)

summary(bootstrap.Cint.model)
plot(bootstrap.Cint.model)
hist(residuals(bootstrap.Cint.model))
shapiro.test(residuals(bootstrap.Cint.model)) #not normal
leveneTest(bootstrap.Cint.model) #not homogenous



#quantiles of normal data
quantile(cool.mono$Cintensity, probs = c(0, 0.5, 0.75, 1))
quantile(cool.poly$Cintensity, probs = c(0, 0.5, 0.75, 1))
quantile(warm.mono$Cintensity, probs = c(0, 0.5, 0.75, 1))
quantile(warm.poly$Cintensity, probs = c(0, 0.5, 0.75, 1))



#Zero inflated glm
#Poisson glm or negative binomial (start with poisson)
```

##Genotype performance
###Lesion Prevalence
```{r}
##Lesion Prevalence
genotype.model <- glm(cbind(lesion, lesion.absent) ~ genotype*treatment + bin/pot, data = filter(bwe, diversity == "mono"), family = binomial)
anova(genotype.model)

mycols.genotype <- cb[c("blue", "grey", "green" , "orange", "pink", "red", "white", "yellow")] #brown = grey, and purple = pink
mycols.genotype.treatment <- cb[c("blue", "blue", "grey", "grey", "green", "green", "orange", "orange", "pink", "pink", "red", "red", "white", "white", "yellow", "yellow")]

#Figures
p <- ggplot(filter(bwe, treatment == "cold") , aes(x = diversity, y = lesion, fill = genotype)) + 
  scale_fill_manual(values = c("blue", "sienna4", "darkgreen", "darkorange", "purple1", "tomato2", "white", "yellow")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.25) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(title = "COLD", x = "Diversity Treatment", y = "Proportion of leaf cover by lesions") +
  theme_classic()
p

p <- ggplot(filter(bwe, treatment == "hot") , aes(x = diversity, y = lesion, fill = genotype)) + 
  scale_fill_manual(values = c("blue", "sienna4", "darkgreen", "darkorange", "purple1", "tomato2", "white", "yellow")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.25) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(title = "HOT", x = "Diversity Treatment", y = "Proportion of leaf cover by lesions") +
  theme_classic()
p
```

###Lesion severity
```{r}
genotype.model <- aov(lc.FS ~ genotype + bin/pot, data = filter(bwe, diversity == "mono" & lesion > 0))
summary(genotype.model)

#Figures
p <- ggplot(filter(bwe, treatment == "cold") , aes(x = diversity, y = lc.FS, fill = genotype)) + 
  scale_fill_manual(values = c("blue", "sienna4", "darkgreen", "darkorange", "purple1", "tomato2", "white", "yellow")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.25) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(title = "COLD", x = "Diversity Treatment", y = "Proportion of leaf cover by lesions") +
  theme_classic()
p

p <- ggplot(filter(bwe, treatment == "hot") , aes(x = diversity, y = lc.FS, fill = genotype)) + 
  scale_fill_manual(values = c("blue", "sienna4", "darkgreen", "darkorange", "purple1", "tomato2", "white", "yellow")) +
  geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.25) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(title = "HOT", x = "Diversity Treatment", y = "Proportion of leaf cover by lesions") +
  theme_classic()
p

##Lesion intensity
p <- ggplot(filter(bwe, treatment == "cold" & lc.FS > 0) , aes(x = diversity, y = lc.FS, fill = genotype)) + 
  scale_fill_manual(values = c("blue", "sienna4", "darkgreen", "darkorange", "purple1", "tomato2", "white", "yellow")) +
  #geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.3) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(title = "COLD", x = "Diversity Treatment", y = "Proportion of diseased leaf cover by lesions") +
  theme_classic()
p

p <- ggplot(filter(bwe, treatment == "hot" & lc.FS > 0) , aes(x = diversity, y = lc.FS, fill = genotype)) + 
  scale_fill_manual(values = c("blue", "sienna4", "darkgreen", "darkorange", "purple1", "tomato2", "white", "yellow")) +
  #geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.3) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(title = "HOT", x = "Diversity Treatment", y = "Proportion of diseased leaf cover by lesions") +
  theme_classic()
p
```

###Cell Prevalence
```{r}
genotype.model <- aov(Cprevalence ~ pot + bin/pot, data = filter(bwe.pot, diversity == "mono"))
summary(genotype.model)

genotype.model <- glm(cbind(lesion, lesion.absent) ~ genotype*treatment + bin/pot, data = filter(bwe, diversity == "mono"), family = binomial)
anova(genotype.model)

#binomial
genotype.model <- glm(cbind(cells.present, cells.absent) ~ genotype + bin/pot, na.action = na.omit, data = filter(bwe, diversity == "mono"), family = binomial)
anova(genotype.model, test = "LR")

#Figures
p <- ggplot(filter(bwe, treatment == "cold") , aes(x = diversity, y = cells.present, fill = genotype)) + 
  scale_fill_manual(values = c("blue", "sienna4", "darkgreen", "darkorange", "purple1", "tomato2", "white", "yellow")) +
  #geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.25) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(title = "COLD", x = "Diversity Treatment", y = "Proportion of shoots with Laby cells detected") +
  theme_classic()
p

p <- ggplot(filter(bwe, treatment == "hot") , aes(x = diversity, y = cells.present, fill = genotype)) + 
  scale_fill_manual(values = c("blue", "sienna4", "darkgreen", "darkorange", "purple1", "tomato2", "white", "yellow")) +
  #geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize  = 0.25, position = position_dodge(1)) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(title = "HOT", x = "Diversity Treatment", y = "Proportion of shoots with Laby cells detected") +
  theme_classic()
p
```

###Cell Severity
```{r}
genotype.model <- aov(log(Cseverity+1) ~ pot + bin, data = filter(bwe.pot, diversity == "mono"))
summary(genotype.model)

#Figures
p <- ggplot(filter(bwe, treatment == "cold"), aes(x  = diversity, y = cell.mg, fill = genotype)) +
  scale_fill_manual(values = c("blue", "sienna4", "darkgreen", "darkorange", "purple1", "tomato2", "white", "yellow")) +
  #geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.25) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(title = "COLD", x = "Diversity Treatment", y = "Laby cells / mg") +
  ylim(0, 100) +
  theme_classic()
p

p <- ggplot(filter(bwe, treatment == "hot"), aes(x = diversity, y = cell.mg, fill = genotype)) +
  scale_fill_manual(values = c("blue", "sienna4", "darkgreen", "darkorange", "purple1", "tomato2", "white", "yellow")) +
  #geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.25) +
  stat_summary(fun.y = mean, geom = "point", size = 3, color = "red", position = position_dodge(1)) +
  labs(title = "HOT", x = "Diversity Treatment", y = "Laby cells / mg") +
  ylim(0, 100) +
  theme_classic()
p

###INTENSITY
genotype.model <- aov(log(cell.mg+1) ~ genotype + bin/pot, data = filter(bwe, diversity == "mono", cells.present > 0))
summary(genotype.model)

#Figures
p <- ggplot(filter(bwe, treatment == "cold" & cell.mg > 0), aes(x  = diversity, y = cell.mg, fill = genotype)) +
  scale_fill_manual(values = c("blue", "sienna4", "darkgreen", "darkorange", "purple1", "tomato2", "white", "yellow")) +
  #geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 1, color = "red", position = position_dodge(1)) +
  labs(title = "COLD", x = "Diversity Treatment", y = "Laby cells / mg in diseased tissue") +
  #ylim(0, 100) +
  theme_classic()
p

p <- ggplot(filter(bwe, treatment == "hot" & cell.mg > 0), aes(x  = diversity, y = cell.mg, fill = genotype)) +
  scale_fill_manual(values = c("blue", "sienna4", "darkgreen", "darkorange", "purple1", "tomato2", "white", "yellow")) +
  #geom_violin(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', position = position_dodge(1), dotsize  = 0.5) +
  stat_summary(fun.y = mean, geom = "point", size = 1, color = "red", position = position_dodge(1)) +
  labs(title = "HOT", x = "Diversity Treatment", y = "Laby cells / mg in diseased tissue") +
  #ylim(0, 100) +
  theme_classic()
p
```



#cell count/mg by genotype, diversity treatment, and temp. treatment
```{r}
bargraph.CI(x.factor = genotype,
            group = diversity,
            response = log(cell.mg + 1),
            data = filter(d04DEC1, cell.mg > 0), #do i want to exclude polys?
            ylim = c(0,10), ylab = "Log(cells per mg + 1)",
            xlab = "Genotype", legend = T)

bargraph.CI(x.factor = diversity,
            response = log(cell.mg + 1),
            data = filter(d04DEC1, cell.mg > 0),
            ylim = c(0,4), ylab = "Log(cells per mg + 1)",
            xlab = "Diversity Treatment")

bargraph.CI(x.factor = treatment,
            response = log(cell.mg + 1),
            data = filter(d04DEC1, cell.mg >0),
            ylim = c(0,4), ylab = "Log(cells per mg + 1)",
            xlab = "Temperature Treatment")

bargraph.CI(x.factor = treatment,
            group = diversity,
            response = log(cell.mg + 1),
            data = filter(d04DEC1, cell.mg > 0),
            ylim = c(0,4), ylab = "Log(cells per mg + 1)",
            xlab = "Diversity Treatment")
```

#cell presence by genotype, diversity treatment, and temp. treatment
```{r}
bargraph.CI(x.factor = genotype,
            group = diversity,
            response = cells.present,
            data = filter(d04DEC1),
            ylim = c(0,1),
            ylab = "Proportion of samples with cells present",
            xlab = "Genotype",
            uc = F, lc = F)

bargraph.CI(x.factor = diversity,
            response = cells.present,
            data = d04DEC1,
            ylim = c(0,1),
            ylab = "Proportion of samples with cells present",
            xlab = "Diversity Treatment",
            uc = F, lc = F)

bargraph.CI(x.factor = treatment,
            response = cells.present,
            data = d04DEC1,
            ylim = c(0,1),
            ylab = "Proportion of samples with cells present",
            xlab = "Temperature Treatment",
            uc = F, lc = F)

bargraph.CI(x.factor = treatment,
            group = diversity,
            response = cells.present,
            data = d04DEC1,
            ylim = c(0,1),
            ylab = "Proportion of samples with cells present",
            xlab = "Temperature Treatment",
            uc = F, lc = F)
```

#cell count per mg by lesion percent cover
```{r}
bwe.intensity <- filter(bwe, cell.mg > 0)

plot(bwe.intensity$lc.FS, log(bwe.intensity$cell.mg+1),
     xlab = "Lesion percent cover",
     ylab = "Log(cells per mg + 1)",
     main = "Lesion Intensity vs. Cell Intensity",
     ylim = c(0,10),
     xlim = c(0,100))

plot(bwe$lc.FS, log(bwe$cell.mg+1),
     xlab = "Lesion percent cover",
     ylab = "Log(cells per mg +1)",
     main = "Lesion % cover vs. Cell count/mg",
     ylim = c(0,10),
     xlim = c(0,50))
```

#Cell presence (qPCR) vs. lesion presence (visual)
```{r}
table.1 <- table(bwe$lesion, bwe$cells.present)

table.1

mosaicplot(table.1, main ="",
xlab = "lesion presence",
           ylab = "cell presence",
           col = T)

table.2 <- table(bwe$lesion.group, bwe$cells.present)
table.2

table.2 <- matrix(c(20,0,41,1,206,33,25,22),ncol=2,byrow=TRUE)
colnames(table.2) <- c("absent","present")
rownames(table.2) <- c("0","<1","<10",">10")
table.2 <- as.table(table.2)
table.2

mosaicplot(table.2, main = "",
           xlab = "lesion percent cover",
           ylab = "cell presence",
           col = T)
```

#Spatial Data Visualization
```{r}
plot(1, type="n", xlab="", ylab="", xlim=c(0.5, 2.5), ylim=c(0.5, 5.5), main="Bin #1")
add.pie(z = c(5,95), x = 1, y = 1, radius = 0.3, col = c("grey", "white"), labels = c("",""), clockwise = TRUE)
add.pie(z = c(10,90), x = 1, y = 2, radius = 0.3, col = c("black","white"), labels = c("",""), clockwise = T)
add.pie(z = c(1.625, 98.375), x = 1, y = 3, radius = 0.3, col = c("yellow","white"), labels = c("",""), clockwise = T)
add.pie(z = c(5.125,94.875), x = 1, y = 4, radius = 0.3, col = c("green","white"), labels = c("",""), clockwise = T)
add.pie(z = c(5,95), x = 1, y = 5, radius = 0.3, col = c("orange","white"), labels = c("",""), clockwise = T)
add.pie(z = c(8.75,91.25), x = 2, y = 1, radius = 0.3, col = c("red", "white"), labels = c("",""), clockwise = TRUE)
add.pie(z = c(5,95), x = 2, y = 2, radius = 0.3, col = c("brown","white"), labels = c("",""), clockwise = T)
add.pie(z = c(5,95), x = 2, y = 3, radius = 0.3, col = c("black","white"), labels = c("",""), clockwise = T)
add.pie(z = c(6.25,93.75), x = 2, y = 4, radius = 0.3, col = c("purple","white"), labels = c("",""), clockwise = T)
add.pie(z = c(5,95), x = 2, y = 5, radius = 0.3, col = c("blue","white"), labels = c("",""), clockwise = T)

plot(1, type="n", xlab="", ylab="", xlim=c(0.5, 2.5), ylim=c(0.5, 5.5), main="Bin #2")
add.pie(z = c(5.125, 100-5.125), x = 1, y = 1, radius = 0.3, col = c("grey", "white"), labels = c("",""), clockwise = TRUE)
add.pie(z = c(8.875, 100-8.875), x = 1, y = 2, radius = 0.3, col = c("yellow","white"), labels = c("",""), clockwise = T)
add.pie(z = c(13.33, 100-13.33), x = 1, y = 3, radius = 0.3, col = c("black","white"), labels = c("",""), clockwise = T)
add.pie(z = c(5, 95), x = 1, y = 4, radius = 0.3, col = c("black","white"), labels = c("",""), clockwise = T)
add.pie(z = c(1.833, 100-1.833), x = 1, y = 5, radius = 0.3, col = c("blue","white"), labels = c("",""), clockwise = T)
add.pie(z = c(15, 85), x = 2, y = 1, radius = 0.3, col = c("purple", "white"), labels = c("",""), clockwise = TRUE)
add.pie(z = c(3.75, 100-3.75), x = 2, y = 2, radius = 0.3, col = c("orange","white"), labels = c("",""), clockwise = T)
add.pie(z = c(3.875, 100-3.875), x = 2, y = 3, radius = 0.3, col = c("green","white"), labels = c("",""), clockwise = T)
add.pie(z = c(1.375, 100-1.375), x = 2, y = 4, radius = 0.3, col = c("red","white"), labels = c("",""), clockwise = T)
add.pie(z = c(5, 95), x = 2, y = 5, radius = 0.3, col = c("brown","white"), labels = c("",""), clockwise = T)


```


#Eelgrass Morphology
```{r}
plot(density ~ treatment, data = bwe.pot)

density.model <- lme(density ~ treatment * diversity, random = ~1 | bin / diversity, data = bwe.pot) #random effects model --> doesn't work :( #cbind(Lpresent, Labsent) #, family = binomial
anova(density.model)

plot(length.mean ~ treatment, data = bwe.pot)

length.model <- lme(length.mean ~ treatment * diversity, random = ~1 | bin / diversity, data = bwe.pot) #random effects model --> doesn't work :( #cbind(Lpresent, Labsent) #, family = binomial
anova(length.model)


```

#disease detection summary stats and sample Lesion to qPCR detection correlation
```{r}
#Lesion detection
  #537/578 total shoots 
    #Cold: Shoots- 170/189; Pots- 50/50
    #Hot:Shoots- 186/189; Pots- 50/50
    #Pulse: Shoots- 181/188 Pots- 50/50

#qPCR cell detections
  #65/378 total shoots
    #Cold: Shoots- 23/189; Pots- 15/50
    #Hot: Shoots- 42/189; Pots- 25/50

#Lesions on Sample to qPCR cell detections
  #Samples with lesion and positive qPCR readings out of all samples with lesions 4/10
  #But, out of the 65 positive qPCR readings the samples with lesions were ranked: 1st, 3rd, 4th, and 6th in terms of infection intensity (cells/mg)



```

