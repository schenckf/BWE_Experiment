---
title: "PrelimAnalysis_19SEP2017"
author: "Forest Schenck"
date: "September 19, 2017"
output: pdf_document
---

#PACKAGES
```{r}
library(dplyr)
library(sciplot)
library(car)
library(lme4)

source("http://faraway.neu.edu/data/Rprofile")
```

#Importing/wrangling data
```{r}
bwe <- read.csv("bwe_data.csv") #importing from dropbox
str(bwe)

bwe$rep <- as.factor(bwe$rep)
bwe$bin <- as.factor(bwe$bin)

bwe$cells.absent <- 1-bwe$cells.present
bwe$lesion.absent <- 1-bwe$lesion

bwe.pot <- bwe %>%
  group_by(diversity, pot, treatment, bin, rep) %>%
  summarize(Lprevalence = mean(lesion, na.rm = T), Lpresent = sum(lesion, na.rm = T), Labsent = sum(lesion.absent, na.rm = T), Lseverity = mean(lc.FS, na.rm = T), Cprevalence = mean(cells.present, na.rm = T), Cpresent = sum(cells.present, na.rm = T), Cabsent = sum(cells.absent, na.rm = T), Cseverity = mean(cell.mg, na.rm = T))

bwe.pot$Lpresent <- as.numeric(bwe.pot$Lpresent)
bwe.pot$Cpresent  <- as.numeric(bwe.pot$Cpresent)

str(bwe.pot)
head(bwe.pot)
```

#ANALYSES
##Lesion Prevalence
```{r}
#Analyses
Lprev.model <- glm(cbind(Lpresent, Labsent) ~ diversity * treatment, family = binomial, data = bwe.pot)
summary(Lprev.model) ### not working

#Figure
bargraph.CI(x.factor = treatment,
            response = Lprevalence,
            data = bwe.pot,
            ylim = c(0,1.1), ylab = "Proportion of shoots with lesions",
            xlab = "Temperature Treatment", legend = T)
```

##Lesion severity
```{r}
#Analyses
Lsev.model <- aov(Lseverity ~ diversity * treatment + Error(bin), data = bwe.pot)
summary(Lsev.model)

#Figure
bargraph.CI(x.factor = treatment,
            response = Lseverity,
            data = bwe.pot,
            ylim = c(0,10), ylab = "Mean lesion percent cover",
            xlab = "Temperature Treatment", legend = T)
```

##Cell Prevalence
```{r}
#Analyses
Cprev.model <-  glm(cbind(Cpresent, Cabsent) ~ diversity * treatment, family = binomial, data = bwe.pot)
summary(Cprev.model)

bargraph.CI(x.factor = treatment,
            group = diversity,
            response = Cprevalence,
            data = bwe.pot,
            ylim = c(0,1), ylab = "Proportion of shoots with disease cells",
            xlab = "Temperature Treatment", legend = T)
```

##Cell severity
```{r}
#Analyses ##DATA IS NOT NORMALLY DISTRIBUTED?
Csev.model <- aov(Cseverity ~ diversity * treatment + Error(bin), data = bwe.pot)
summary(Csev.model)

#checking assumptions
Csev.model.2 <- aov(log(Cseverity+1) ~ diversity * treatment + bin, data = bwe.pot)
summary(Csev.model.2)
plot(Csev.model.2, 1)
plot(Csev.model.2, 2)
plot(Csev.model.2, 5)
boxCox(Csev.model.2)

#exploratory figure
bargraph.CI(x.factor = treatment,
            group = diversity,
            response = log(Cseverity+1),
            data = bwe.pot,
            ylim = c(0,2), ylab = "disease cells/mg",
            xlab = "Temperature Treatment", legend = T)

##only for pots with disease -->intensity MODEL INCORRECT
Cintensity.model <- aov(log(Cseverity + 1) ~ treatment * diversity + Error(bin), data = filter(bwe.pot, Cprevalence > 0))
summary(Cintensity.model)

#Figure
bargraph.CI(x.factor = treatment,
            group = diversity,
            response = Cseverity,
            data = filter(bwe.pot, Cprevalence > 0),
            ylim = c(0,1000), ylab = "Log(cells/mg)",
            xlab = "Temperature Treatment", legend = T)
##only for monocultures
Cintensity.model <- aov(log(Cseverity + 1) ~ treatment + Error(bin), data = filter(bwe.pot, diversity == "mono"))
summary(Cintensity.model)
```

##Genotype performance
```{r}
##Lesion Prevalence
genotype.model <- glm(cbind(lesion, lesion.absent) ~ genotype*treatment + bin/pot, data = filter(bwe, diversity == "mono"), family = binomial)
anova(genotype.model)

mycols.genotype <- cb[c("blue", "grey", "green" , "orange", "pink", "red", "white", "yellow")] #brown = grey, and purple = pink
mycols.genotype.treatment <- cb[c("blue", "blue", "grey", "grey", "green", "green", "orange", "orange", "pink", "pink", "red", "red", "white", "white", "yellow", "yellow")]

bargraph.CI(x.factor = genotype,
            response = lesion,
            data = filter(bwe, diversity == "mono"),
            ylim = c(0,1.1), ylab = "Proportion of shoots with lesions",
            xlab = "Genotype", legend = T,
            col = mycols.genotype)

#Lesion severity
genotype.model <- aov(lc.FS ~ genotype + bin/pot, data = filter(bwe, diversity == "mono" & lesion > 0))
summary(genotype.model)

bargraph.CI(x.factor = genotype,
            response = lc.FS,
            data = filter(bwe, diversity == "mono" & lesion > 0),
            ylim = c(0,15), ylab = "Lesion percent cover",
            xlab = "Genotype", legend = T,
            col = mycols.genotype)

#Cell prevalence
genotype.model <- aov(Cprevalence ~ pot + bin/pot, data = filter(bwe.pot, diversity == "mono"))
summary(genotype.model)

genotype.model <- glm(cbind(lesion, lesion.absent) ~ genotype*treatment + bin/pot, data = filter(bwe, diversity == "mono"), family = binomial)
anova(genotype.model)

bargraph.CI(x.factor = pot,
            response = Cprevalence,
            data = filter(bwe.pot, diversity == "mono"),
            ylim = c(0,1), ylab = "Proportion of shoots with disease cells",
            xlab = "Genotype", legend = T,
            col = mycols.genotype)

#binomial
genotype.model <- glm(cbind(cells.present, cells.absent) ~ genotype + bin/pot, na.action = na.omit, data = filter(bwe, diversity == "mono"), family = binomial)
anova(genotype.model, test = "LR")

bargraph.CI(x.factor = genotype,
            response = cells.present,
            data = filter(bwe, diversity == "mono"),
            ylim = c(0,1), ylab = "Proportion of shoots with disease cells",
            xlab = "Genotype", legend = T,
            col = mycols.genotype)

#Cell Severity
genotype.model <- aov(log(Cseverity+1) ~ pot + bin, data = filter(bwe.pot, diversity == "mono"))
summary(genotype.model)

###INTENSITY
genotype.model <- aov(log(cell.mg+1) ~ genotype + bin/pot, data = filter(bwe, diversity == "mono", cells.present > 0))
summary(genotype.model)

bargraph.CI(x.factor = genotype,
            response = log(cell.mg+1),
            data = filter(bwe, diversity == "mono", cells.present > 0),
            ylim = c(0,5), ylab = "log(cells/mg +1)",
            xlab = "Genotype", legend = T,
            col = mycols.genotype)
```





#cell count/mg by genotype, diversity treatment, and temp. treatment
```{r}
bargraph.CI(x.factor = genotype,
            group = diversity,
            response = log(cell.mg + 1),
            data = filter(d04DEC1, cell.mg > 0), #do i want to exclude polys?
            ylim = c(0,10), ylab = "Log(cells per mg + 1)",
            xlab = "Genotype", legend = T)

bargraph.CI(x.factor = diversity,
            response = log(cell.mg + 1),
            data = filter(d04DEC1, cell.mg > 0),
            ylim = c(0,4), ylab = "Log(cells per mg + 1)",
            xlab = "Diversity Treatment")

bargraph.CI(x.factor = treatment,
            response = log(cell.mg + 1),
            data = filter(d04DEC1, cell.mg >0),
            ylim = c(0,4), ylab = "Log(cells per mg + 1)",
            xlab = "Temperature Treatment")

bargraph.CI(x.factor = treatment,
            group = diversity,
            response = log(cell.mg + 1),
            data = filter(d04DEC1, cell.mg > 0),
            ylim = c(0,4), ylab = "Log(cells per mg + 1)",
            xlab = "Diversity Treatment")
```

#cell presence by genotype, diversity treatment, and temp. treatment
```{r}
bargraph.CI(x.factor = genotype,
            group = diversity,
            response = cells.present,
            data = filter(d04DEC1),
            ylim = c(0,1),
            ylab = "Proportion of samples with cells present",
            xlab = "Genotype",
            uc = F, lc = F)

bargraph.CI(x.factor = diversity,
            response = cells.present,
            data = d04DEC1,
            ylim = c(0,1),
            ylab = "Proportion of samples with cells present",
            xlab = "Diversity Treatment",
            uc = F, lc = F)

bargraph.CI(x.factor = treatment,
            response = cells.present,
            data = d04DEC1,
            ylim = c(0,1),
            ylab = "Proportion of samples with cells present",
            xlab = "Temperature Treatment",
            uc = F, lc = F)

bargraph.CI(x.factor = treatment,
            group = diversity,
            response = cells.present,
            data = d04DEC1,
            ylim = c(0,1),
            ylab = "Proportion of samples with cells present",
            xlab = "Temperature Treatment",
            uc = F, lc = F)
```

#cell count per mg by lesion percent cover
```{r}
bwe.intensity <- filter(bwe, cell.mg > 0)

plot(bwe.intensity$lc.FS, log(bwe.intensity$cell.mg+1),
     xlab = "Lesion percent cover",
     ylab = "Log(cells per mg + 1)",
     main = "Lesion Intensity vs. Cell Intensity",
     ylim = c(0,10),
     xlim = c(0,100))

plot(bwe$lc.FS, log(bwe$cell.mg+1),
     xlab = "Lesion percent cover",
     ylab = "Log(cells per mg +1)",
     main = "Lesion % cover vs. Cell count/mg",
     ylim = c(0,10),
     xlim = c(0,50))
```

#Cell presence (qPCR) vs. lesion presence (visual)
```{r}
table.1 <- table(bwe$lesion, bwe$cells.present)

table.1

mosaicplot(table.1, main ="",
xlab = "lesion presence",
           ylab = "cell presence",
           col = T)

table.2 <- table(bwe$lesion.group, bwe$cells.present)
table.2

table.2 <- matrix(c(20,0,41,1,206,33,25,22),ncol=2,byrow=TRUE)
colnames(table.2) <- c("absent","present")
rownames(table.2) <- c("0","<1","<10",">10")
table.2 <- as.table(table.2)
table.2

mosaicplot(table.2, main = "",
           xlab = "lesion percent cover",
           ylab = "cell presence",
           col = T)
```




